#!/bin/sh

if [ -f "$1" ]; then
	tipo="$(file -b --mime-type "$1" | rev| cut -d' ' -f1 | rev)"
	case $tipo in
		application/pg*) gpg -d "$1";;
		*) gpg -ca "$1";;
	esac
fi
[ -n "$1" ] && exit

verde='\033[0;32m'
clave=$(cat << EOF | fzf
generar nueva clave
importar clave
eliminar claves privada-publica
exportar a clave publica
desencriptar volcando a archivo
desencriptar en directorio
desencriptar sin volcado
encriptar para otro usuario
servidores de claves
firmar digitalmente
exportar clave privada
(10) editar clave
listar claves privadas
verificar firma digital
(14) detectar archivos encriptados
encriptar en una imagen
EOF
)

case $clave in
	"generar nueva clave") gpg --full-generate-key;;
	"importar clave") a=$(find . -maxdepth 1 | fzf --cycle --height=15) && [ -n "$a" ] && gpg --import "$a";;
	"eliminar claves privada-publica") gpg --list-keys && a=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& gpg --delete-secret-keys "$a" && gpg --delete-keys "$a" && gpg -k;;
	"exportar a clave publica") gpg --list-keys && a=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& gpg -a --export -o k.pub "$a";;
	"desencriptar volcando a archivo") a=$(find . | fzf --cycle --height=15 --prompt='elige archivo: ') \
		&& gpg -o "$a".des --decrypt "$a";;
	"desencriptar sin volcado") a=$(find . -maxdepth 2 | fzf --cycle --reverse --prompt='archivo a desncriptar: ') && gpg --decrypt "$a";;
	"encriptar para otro usuario") gpg --list-keys && printf "destinatario: " \
		&&  a=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& printf "archivo a cifrar: " && b=$(find . -maxdepth 1 | fzf --cycle --height=15) \
		&& gpg -v -a -o mensaje.cifrado --encrypt --recipient "$a" "$b";; 
	"servidores de claves") a=$(printf "enviar clave publica a servidor de claves\\nbuscar clave publica en servidor de claves\\ndescargar clave publica de servidor de claves\\n"|
		fzf --cycle --height=10);;
	"firmar digitalmente") printf "%s$verde archivo a firmar: " && a=$(find . -maxdepth 1 | fzf --cycle --height=15) && gpg --clearsign "$a";;
	"exportar clave privada") gpg --list-keys && a=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& gpg -ao nueva.priv --export-secret-keys "$a";;
	"11") gpg --list-keys && printf "usuario local" && a=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& printf "usuario destinatario" && b=$(gpg -k | awk '/pub/{getline; print}' | tail -n +2 | fzf --cycle --height=15) \
		&& printf "archivo a firmar: " && c=$(find . | fzf --cycle --height=15) && gpg -u "$a" --sign -o nuevo_archivo2 --encrypt -r "$b" "$c";;
	"listar claves privadas") gpg --list-secret-keys --keyid-format LONG;;
	"verificar firma digital") a=$(printf "%s$verde firma digital: ") && gpg --verify "$a";;
	"encriptar en una imagen") a=$(printf "%s$verde firma digital: ") && gpg --verify "$a";;
	"desencriptar en directorio") a="$(file --mime-type * | grep 'application/pgp')" \
		&& b="$(printf "$a" | fzf)" && [ -n "$b" ] \
		&& name=$(echo "$b" |cut -d' ' -f1 |tr -d ':') \
		&& tipo=$(echo "$b" |rev | cut -d' ' -f1|rev) \
		&& [ -z "$b" ] && exit
		case $tipo in
			application/pg*) gpg -d "$name" ;;
		esac
		;;
esac

#encriptar para destinatario
#a=$(gpg -k | awk '/pub/{getline; print}' | sed '1d' | fzf --cycle --height=15)
#gpg -v -a -o mensaje.cifrado --encrypt --recipient $a archivo_a_cifrar 
#gpg --fingerprint

#encriptar asimetrica para usuario destinatario
#gpg --encrypt -a -r gonzalo@gmail.com hola

#firmar archivo
#printf "usuario local"
#a=$(gpg -k | awk '/pub/{getline; print}' | sed '1d' | fzf --cycle --height=15)
#printf "usuario destinatario"
#b=$(gpg -k | awk '/pub/{getline; print}' | sed '1d' | fzf --cycle --height=15)
#gpg -u $a --sign -o nuevo_archivo --encrypt -r $b archivo_a_firmar

#firmar
#gpg --clearsign archivo_a_firmar

#a=$(gpg -k | awk '/pub/{getline; print}' | sed '1d' | fzf --cycle --height=15)
#gpg --send-keys --keyserver pgp.rediris.es $a

#a=$(gpg -k | awk '/pub/{getline; print}' | sed '1d' | fzf --cycle --height=15)
#gpg --key-server pgp.rediris.es --search-keys $a 

#gpg --keyserver pgp.rediris.es --recv-keys id
 
#gpg --list-secret-keys --keyid-format LONG
