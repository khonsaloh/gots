#!/bin/sh

url=$(xclip -o 2>/dev/null)

case $1 in
	-e) $EDITOR $(readlink -f "$0") && exit ;;
esac
[ -n "$url" ] && [ -z "$(echo $url | grep '^htt')" ] \
	&& printf "pon url del elemento a descargar: " && read -r url 
[ -z "$url" ] && printf "pon url del elemento a descargar: " && read -r url

dir=/tmp/vid/
tiempo=$(date +%Y%m%d%H%M%S)

[ ! -f $dir ] && mkdir -p $dir

#select=fzf

vid=$(fzf --prompt='gestor de descarga: ' << GON
ver formatos en servidor
descargar miniatura
descargar video
descargar por defecto mejor resolucion
descargar parte de video
descargar parte de video sin audio
descargar parte de audio
descargar lista de reproduccion
descargar metadatos (json)
descargar audio solo
GON
)
case $vid in
	ver*) youtube-dl -F "$url";;
	"descargar miniatura") youtube-dl --write-thumbnail --skip-download "$url";;
	"descargar video") formato="$(youtube-dl -F "$url"| tail -n +4 \
		|fzf --tac -m --prompt="tab para seleccionar, pon codigo (primero del video, luego audio): " \
		|cut -d' ' -f1)" && [ -z "$formato" ] && exit || [ $(echo $formato | wc -w) -eq 1 ] \
		&& youtube-dl -4 -f $formato $url && exit || formato=$(printf "%s" "$formato" | paste -d' ' - - | tr ' ' '+') \
		&& youtube-dl -4 -f $formato $url && notify-send "video descargado en $dir" && exit;;
	"descargar por defecto mejor resolucion") youtube-dl "$url";;
	" ") youtube-dl -g "$url" | awk '{ if(NR==1) print $0 }' | sed "s/^/'/;s/$/'/" |xargs -I {} ffmpeg -i "{}" \
		-c:v copy -ss 0 -t 10 pruebar.mp4;;
		"descargar parte de video") formato=$(youtube-dl -F "$url" | tail -n +4 |fzf --tac -m --prompt="elige formatos: " | cut -d' ' -f1) \
		&& [ -n "$formato" ] && num=$(echo $formato | wc -w)
		case $num in
			1) printf "desde donde quieres cortar (inicio)? " \
				&& read -r inicio && printf "hasta donde quieres cortar? " \
				&& read -r fin && youtube-dl -f "$formato" -g "$url"| 
				awk '{ if(NR==1) print $0 }' | sed "s/^/'/;s/$/'/" | xargs -I {} ffmpeg -hide_banner -i "{}" \
				-c:v libx264 -ss $inicio -to $fin /tmp/$tiempo.mkv;;
			*) formato=$(printf "%s" "$formato" | paste -d' ' - - | tr ' ' '+') && printf "desde donde quieres cortar (inicio)? " \
				&& read -r inicio && printf "hasta donde quieres cortar? " \
				&& read -r fin && youtube-dl -f "$formato" -g "$url" | xargs -I {} ffmpeg -hide_banner -i "{}" \
				-c:v libx264 -ss $inicio -to $fin /tmp/$tiempo.mkv;; # no funciona como es debido
		esac;;
	"descargar parte de audio") printf "comienzo: " && read -r com && printf "fin: " && read -r fin \
		&& youtube-dl -g "$url" |awk '{ if(NR==2) print $0 }' | sed "s/^/'/;s/$/'/" | xargs -I {} ffmpeg \
		-hide_banner -i "{}" -ss "$com" -to "$fin" $dir$tiempo.mp3;;
	#"descargar lista de reproduccion") youtube-dl -i $dir$tiempo"%(title)s.%(ext)s" "$url" ;;
	"descargar lista de reproduccion") lista="$(fzf <<- GON
			descargar lista entera
			descargar (solo audio)
			elegir rango de videos
			descargar videos concretos o salteados
			GON
			)"
			case "$lista" in
				"descargar (solo audio)") 
					youtube-dl -extract-audio -i --yes-playlist "$url" ;;
				"descargar lista entera") 
					youtube-dl -i --yes-playlist "$url" ;;
				"elegir rango de videos") 
					printf "pon rango separado por - " && read -r indice \
						&& youtube-dl -c -i --yes-playlist --playlist-items "$indice" "$url" ;;
				"descargar videos concretos o salteados") 
					printf "pon indices de la lista que quieres descargar separados por comas: " && read -r indice \
						&& youtube-dl -c -i --yes-playlist --playlist-items "$indice" "$url" ;;
			esac ;;
	"descargar lista de reproduccion (solo audio)") youtube-dl -extract-audio -i --yes-playlist "$url" ;;
	"descargar metadatos (json)") youtube-dl --write-info-json "$url";;
	"descargar audio solo") formato=$(youtube-dl -F "$url" |grep 'audio' | fzf --prompt='selecciona uno: ' | cut -d' ' -f1) \
		&& [ -n "$formato" ] && youtube-dl -f "$formato" "$url" \
		&& notify-send "video descargado en $dir";;
esac
echo

#ffplay -i "url"
#add quotes between
#sed 's/^/"/;s/$/"/'
