#!/bin/sh

dummy=/tmp/canales
opt="--ytdl-raw-options=force=ipv4="
u_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
case $1 in
	-es|es) a="$(curl -4 -sf 'https://www.tdtchannels.com/lists/tv.m3u' | grep -v '#')" && vent=$(xdo id) && xdo hide $vent
		while true; do
			b="$(echo "$a" | dmenu -i -l 30 -sb '#661a1a' -p 'television española')"
			[ -z "$b" ] && xdo show $vent && exit || /usr/bin/mpv --really-quiet \
				--user-agent="$u_agent" "$b" 
		done &
		;; #individuales
	
	-radio|-r) a="$(curl -4 -sf 'https://www.tdtchannels.com/lists/radio.m3u8' | grep -v '#')"
		while true; do
			b="$(echo "$a" | dmenu -i -l 30 -sb '#661a1a' -p 'television española')"
				[ -z "$b" ] && exit || /usr/bin/mpv --really-quiet "$b" 2>/dev/null
		done
		;;
	
	--help|-h|h) printf "opciones son -es, -radio, --descargar, --lista -li\\n" ;;
	
	-d|--descargar) a=$(curl -4 -sf 'https://raw.githubusercontent.com/iptv-org/iptv/master/README.md'  |
		awk '/http/' | grep -o -P '(?<=code>).*(?=</code)' | sed 's/<.*//' |
		dmenu -i -l 30 -sb '#661a1a' -p 'television') && b=$(curl -4 -sf "$a" | grep -v '#') && /usr/bin/mpv --really-quiet $b ;;
	
	--lista|-l|l) b="$(curl -4 -sf https://raw.githubusercontent.com/iptv-org/iptv/master/README.md | grep 'http' |
		grep -o -P '(?<=code>).*(?=</code)' | sed 's/<.*//')" #&& vent=$(xdotool getactivewindow) && xdotool windowunmap $vent #kill $vent
		vent=$(xdo id) && xdo hide $vent
		while true; do
			c="$(echo "$b" | /usr/local/bin/dmenu -i -l 30 -p television  -sb '#7a998d' -nb '#262626' )"
			[ -z "$c" ] && xdo show $vent && exit
			/usr/bin/mpv --profile=playlist \
				$opt --user-agent="$u_agent" "$c"
		done & 
		;;
	
	--li|-li|li) /usr/bin/mpv --profile=playlist $opt --user-agent="$u_agent" \
		$(curl -4 -sf  'https://www.tdtchannels.com/lists/tv.w3u' | jq '.groups[].stations[] | "\(.name) \(.url)"' |dmenu -i -l 30 -p television -sb '#661a1a' ) >/dev/null & ;;
esac

[ -n "$1" ] && exit

a="$(curl -4 -sf https://iptv-org.github.io/iptv/channels.json | jq '.[] | "\(.name) \(.url)"' | tr -d '"')"

while true; do
	b="$(echo "$a" | dmenu -i -l 30 -sb '#661a1a' -p 'canal' -fn 'Ubuntu Mono' | awk '{print $NF}')" && [ -z "$b" ] && exit
	mpv --really-quiet --user-agent="$u_agent" $opt "$b" #>/dev/null 2>&1 #individuales
done &
